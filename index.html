<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tessera Punti Digitale</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            margin: auto;
            margin-bottom: 25px;
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            background: #007BFF;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        button:hover {
            background: #0056b3;
        }

        .btn-admin {
            background: #28a745;
        }

        .btn-admin:hover {
            background: #1e7e34;
        }

        #punti, #conto-alla-rovescia {
            font-size: 22px;
            font-weight: bold;
            margin-top: 15px;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
        }

        th {
            background: #007BFF;
            color: white;
        }

        #barcode-img {
            width: 100%;
            max-width: 250px;
            margin-top: 20px;
        }
    </style>
</head>

<body>

<!-- MENU INIZIALE -->
<div class="container" id="menu-iniziale">
    <h2>Tessera Punti Digitale</h2>

    <button onclick="mostraRegistrazione()">Nuova Tessera</button>
    <button onclick="mostraAccesso()">Accedi con ID Tessera</button>
</div>

<!-- REGISTRAZIONE NUOVA TESSERA -->
<div class="container" id="registrazione" style="display: none;">
    <h2>Crea Nuova Tessera</h2>

    <input type="text" id="nome" placeholder="Nome">
    <input type="text" id="cognome" placeholder="Cognome">

    <button onclick="creaNuovaTessera()">Crea Tessera</button>
    <button onclick="tornaMenu()">Indietro</button>
</div>

<!-- ACCESSO TESSERA ESISTENTE -->
<div class="container" id="accesso" style="display: none;">
    <h2>Accedi alla Tessera</h2>

    <input type="text" id="codice-tessera" placeholder="Inserisci ID tessera">
    <button onclick="accediTessera()">Accedi</button>
    <button onclick="tornaMenu()">Indietro</button>
</div>

<!-- PAGINA TESSERA -->
<div class="container" id="tessera" style="display: none;">
    <h3>Benvenuto, <span id="nome-salvato"></span> <span id="cognome-salvato"></span></h3>

    <img id="barcode-img" src="Tessera Punti Biglietto da Visita.png">

    <h3>ID Tessera: <span id="id-tessera-top"></span></h3>

    <h3>Punti Accumulati</h3>
    <p id="punti">0</p>

    <input type="text" id="codice" placeholder="Inserisci codice segreto">
    <button onclick="aggiungiPunto()">Aggiungi Punto</button>

    <h3>Storico Punti</h3>
    <table>
        <thead>
            <tr>
                <th>Punti</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody id="storico-punti"></tbody>
    </table>

    <br>
    <button class="btn-admin" onclick="window.location.href='admin.html'">Area Admin</button>
    <button onclick="tornaMenu()">Esci</button>
</div>

<!-- FIREBASE + FIRESTORE -->
<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, doc, setDoc, getDoc, updateDoc, arrayUnion, increment 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC4zVOTBEFdO3SSDtfyPSEUBlXk-VljFKw",
        authDomain: "tessera-punti.firebaseapp.com",
        projectId: "tessera-punti",
        storageBucket: "tessera-punti.firebasestorage.app",
        messagingSenderId: "1093156020505",
        appId: "1:1093156020505:web:1a693de1df1cd6eef92588",
        measurementId: "G-0STSVW8R8P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const codiceSegreto = "060471";

    function tornaMenu() {
        document.querySelectorAll(".container").forEach(c => c.style.display = "none");
        document.getElementById("menu-iniziale").style.display = "block";
    }

    function mostraRegistrazione() {
        document.getElementById("menu-iniziale").style.display = "none";
        document.getElementById("registrazione").style.display = "block";
    }

    function mostraAccesso() {
        document.getElementById("menu-iniziale").style.display = "none";
        document.getElementById("accesso").style.display = "block";
    }

    // CREA TESSERA SU FIRESTORE
    async function creaNuovaTessera() {
        let nome = document.getElementById("nome").value.trim();
        let cognome = document.getElementById("cognome").value.trim();

        const ref = doc(collection(db, "clienti"));

        await setDoc(ref, {
            nome: nome,
            cognome: cognome,
            id: ref.id,
            punti: 0,
            storico: []
        });

        mostraTessera({
            nome: nome,
            cognome: cognome,
            id: ref.id,
            punti: 0,
            storico: []
        });
    }

    // ACCESSO TESSERA
    async function accediTessera() {
        let id = document.getElementById("codice-tessera").value.trim();
        const ref = doc(db, "clienti", id);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
            alert("ID non trovato");
            return;
        }

        mostraTessera(snap.data());
    }

    // MOSTRA TESSERA
    function mostraTessera(cliente) {
        document.querySelectorAll(".container").forEach(c => c.style.display = "none");
        document.getElementById("tessera").style.display = "block";

        document.getElementById("nome-salvato").textContent = cliente.nome;
        document.getElementById("cognome-salvato").textContent = cliente.cognome;
        document.getElementById("id-tessera-top").textContent = cliente.id;
        document.getElementById("punti").textContent = cliente.punti;

        caricaStorico(cliente);
    }

    // AGGIUNGI PUNTO
    async function aggiungiPunto() {
        let codice = document.getElementById("codice").value.trim();
        let id = document.getElementById("id-tessera-top").textContent;

        if (codice !== codiceSegreto) {
            alert("Codice errato");
            return;
        }

        const ref = doc(db, "clienti", id);

        await updateDoc(ref, {
            punti: increment(1),
            storico: arrayUnion({
                punti: 1,
                data: new Date().toLocaleString()
            })
        });

        const snap = await getDoc(ref);
        mostraTessera(snap.data());
    }

    // STORICO
    function caricaStorico(cliente) {
        let tabella = document.getElementById("storico-punti");
        tabella.innerHTML = "";

        cliente.storico.forEach(entry => {
            let riga = document.createElement("tr");
            riga.innerHTML = `<td>${entry.punti}</td><td>${entry.data}</td>`;
            tabella.appendChild(riga);
        });
    }

</script>

</body>
</html>
