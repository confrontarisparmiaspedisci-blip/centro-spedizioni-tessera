<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tessera Punti Digitale con Barcode</title>

    <!-- Libreria Barcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            margin: auto;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007BFF;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #0056b3;
        }
        #punti, #conto-alla-rovescia {
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ccc;
        }
        th {
            background: #007BFF;
            color: white;
        }
        #barcode {
            margin-top: 20px;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>Tessera Punti Digitale</h2>
    
    <div id="registrazione">
        <p>Registrati per iniziare</p>
        <input type="text" id="nome" placeholder="Nome e Cognome">
        <button onclick="salvaNome()">Salva</button>
    </div>

    <div id="tessera" style="display: none;">
        <h3>Benvenuto, <span id="nome-salvato"></span>!</h3>

        <h3>ID Tessera</h3>
        <p id="id-tessera"></p>

        <svg id="barcode"></svg>

        <h3>Punti Accumulati</h3>
        <p id="punti">0</p>

        <h3>Inserisci il Codice Segreto</h3>
        <input type="text" id="codice" placeholder="Inserisci codice">
        <button onclick="aggiungiPunto()">Aggiungi Punto</button>

        <h3>Tempo Rimanente</h3>
        <p id="conto-alla-rovescia">N/A</p>

        <h3>Storico Punti</h3>
        <table>
            <thead>
                <tr>
                    <th>Punti</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody id="storico-punti"></tbody>
        </table>

        <br>
        <button onclick="window.location.href='admin.html'" 
                style="background:#28a745; color:white; padding:12px; border:none; border-radius:6px; font-size:18px; cursor:pointer;">
            Accedi allâ€™Area Admin
        </button>

    </div>
</div>

<script>
    const codiceSegreto = "060471";
    const codiceReset = "finepromo";

    const BASE_URL = "https://confrontarisparmiaspedisci-blip.github.io/centro-spedizioni-tessera/";

    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    function generaIDOffuscato() {
        return Math.random().toString(36).substring(2, 10) + Date.now().toString(36).substring(4);
    }

    function generaLinkTessera(idOffuscato) {
        return BASE_URL + "?id=" + encodeURIComponent(idOffuscato);
    }

    function caricaClienteDaAdmin(idOffuscato) {
        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");
        return lista.find(c => c.idOffuscato === idOffuscato) || null;
    }

    function salvaClienteInAdmin(cliente) {
        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");
        const esiste = lista.find(c => c.idOffuscato === cliente.idOffuscato);
        if (!esiste) {
            lista.push(cliente);
            localStorage.setItem("clienti", JSON.stringify(lista));
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const idOffuscato = getQueryParam("id");

        if (idOffuscato) {
            const cliente = caricaClienteDaAdmin(idOffuscato);
            if (cliente) {
                mostraTesseraEsistente(cliente);
                return;
            }
        }

        document.getElementById("registrazione").style.display = "block";
        document.getElementById("tessera").style.display = "none";
    });

    function mostraTesseraEsistente(cliente) {
        document.getElementById("registrazione").style.display = "none";
        document.getElementById("tessera").style.display = "block";

        document.getElementById("nome-salvato").textContent = cliente.nome;
        document.getElementById("id-tessera").textContent = cliente.idOffuscato;

        // ðŸ”µ Barcode: contiene il LINK, ma sotto mostriamo solo lâ€™ID
        generaBarcode(cliente.link, cliente.idOffuscato);

        document.getElementById("punti").textContent = cliente.punti || 0;

        caricaStoricoDaCliente(cliente);
        aggiornaContoAllaRovesciaDaCliente(cliente);
    }

    function salvaNome() {
        let nome = document.getElementById("nome").value.trim();
        if (nome.length < 3) {
            alert("Inserisci un nome valido!");
            return;
        }

        const idOffuscato = generaIDOffuscato();
        const link = generaLinkTessera(idOffuscato);

        const cliente = {
            nome: nome,
            idOffuscato: idOffuscato,
            link: link,
            punti: 0,
            storico: [],
            dataInizio: null
        };

        salvaClienteInAdmin(cliente);

        // Reindirizza subito alla sua tessera (link unico)
        window.location.href = link;
    }

    // ðŸ”µ NUOVA VERSIONE: il barcode usa il link, ma il testo sotto Ã¨ lâ€™ID
    function generaBarcode(link, idOffuscato) {
        JsBarcode("#barcode", link, {
            format: "code128",
            lineColor: "#000",
            width: 2,
            height: 60,
            displayValue: false   // NON mostra il link sotto il barcode
        });

        // Sotto il barcode mostriamo solo lâ€™ID tessera
        document.getElementById("id-tessera").textContent = idOffuscato;
    }

    function aggiungiPunto() {
        let codiceInserito = document.getElementById("codice").value.trim();
        const idOffuscato = getQueryParam("id");
        if (!idOffuscato) {
            alert("Errore: nessun ID tessera trovato.");
            return;
        }

        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");
        let cliente = lista.find(c => c.idOffuscato === idOffuscato);

        if (!cliente) {
            alert("Cliente non trovato.");
            return;
        }

        if (codiceInserito === codiceSegreto) {
            cliente.punti = (cliente.punti || 0) + 1;

            let data = new Date().toLocaleString();
            cliente.storico = cliente.storico || [];
            cliente.storico.push({ punti: 1, data: data });

            if (!cliente.dataInizio) {
                cliente.dataInizio = Date.now();
            }

            salvaListaClienti(lista);

            document.getElementById("punti").textContent = cliente.punti;
            caricaStoricoDaCliente(cliente);
            aggiornaContoAllaRovesciaDaCliente(cliente);

            alert("Punto aggiunto! Punti totali: " + cliente.punti);

            if (cliente.punti === 10) {
                alert("Complimenti! Hai accumulato 10 punti e hai una spedizione da 20kg gratuita!");
                resetPuntiCliente(cliente, lista);
            }

        } else if (codiceInserito === codiceReset) {
            resetPuntiCliente(cliente, lista);
            alert("Promozione resettata!");
        } else {
            alert("Codice errato!");
        }

        document.getElementById("codice").value = "";
    }

    function salvaListaClienti(lista) {
        localStorage.setItem("clienti", JSON.stringify(lista));
    }

    function caricaStoricoDaCliente(cliente) {
        let tabella = document.getElementById("storico-punti");
        tabella.innerHTML = "";
        (cliente.storico || []).forEach((entry) => {
            let riga = document.createElement("tr");
            riga.innerHTML = `<td>${entry.punti}</td><td>${entry.data}</td>`;
            tabella.appendChild(riga);
        });
    }

    function aggiornaContoAllaRovesciaDaCliente(cliente) {
        if (!cliente.dataInizio) {
            document.getElementById("conto-alla-rovescia").textContent = "N/A";
            return;
        }
        let scadenza = parseInt(cliente.dataInizio) + (365 * 24 * 60 * 60 * 1000);
        let adesso = Date.now();
        let differenza = scadenza - adesso;

        if (differenza <= 0) {
            document.getElementById("conto-alla-rovescia").textContent = "Tempo scaduto!";
            return;
        }

        let giorniRimanenti = Math.floor(differenza / 86400000);
        document.getElementById("conto-alla-rovescia").textContent = `${giorniRimanenti} giorni rimanenti`;
    }

    function resetPuntiCliente(cliente, lista) {
        cliente.punti = 0;
        cliente.storico = [];
        cliente.dataInizio = null;
        salvaListaClienti(lista);

        document.getElementById("punti").textContent = "0";
        document.getElementById("conto-alla-rovescia").textContent = "N/A";
        caricaStoricoDaCliente(cliente);
    }

    setInterval(function () {
        const idOffuscato = getQueryParam("id");
        if (!idOffuscato) return;
        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");
        let cliente = lista.find(c => c.idOffuscato === idOffuscato);
        if (cliente) {
            aggiornaContoAllaRovesciaDaCliente(cliente);
        }
    }, 60000);
</script>

</body>
</html>
