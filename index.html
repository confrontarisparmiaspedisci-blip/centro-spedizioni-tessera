<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tessera Punti Digitale</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            margin: auto;
            margin-bottom: 25px;
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            background: #007BFF;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        button:hover {
            background: #0056b3;
        }

        .btn-admin {
            background: #28a745;
        }

        .btn-admin:hover {
            background: #1e7e34;
        }

        #punti, #conto-alla-rovescia {
            font-size: 22px;
            font-weight: bold;
            margin-top: 15px;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
        }

        th {
            background: #007BFF;
            color: white;
        }

        #barcode-img {
            width: 100%;
            max-width: 250px;
            margin-top: 20px;
        }
    </style>
</head>

<body>

<!-- MENU INIZIALE -->
<div class="container" id="menu-iniziale">
    <h2>Tessera Punti Digitale</h2>

    <button onclick="mostraRegistrazione()">Nuova Tessera</button>
    <button onclick="mostraAccesso()">Accedi con ID Tessera</button>
</div>

<!-- REGISTRAZIONE NUOVA TESSERA -->
<div class="container" id="registrazione" style="display: none;">
    <h2>Crea Nuova Tessera</h2>

    <input type="text" id="nome" placeholder="Nome">
    <input type="text" id="cognome" placeholder="Cognome">

    <button onclick="salvaNuovaTessera()">Crea Tessera</button>
    <button onclick="tornaMenu()">Indietro</button>
</div>

<!-- ACCESSO TESSERA ESISTENTE -->
<div class="container" id="accesso" style="display: none;">
    <h2>Accedi alla Tessera</h2>

    <input type="text" id="codice-tessera" placeholder="Inserisci ID tessera">
    <button onclick="accediTessera()">Accedi</button>
    <button onclick="tornaMenu()">Indietro</button>
</div>

<!-- PAGINA TESSERA -->
<div class="container" id="tessera" style="display: none;">
    <h3>Benvenuto, <span id="nome-salvato"></span> <span id="cognome-salvato"></span></h3>

    <img id="barcode-img" src="Tessera Punti Biglietto da Visita.png">

    <h3>ID Tessera: <span id="id-tessera-top"></span></h3>

    <h3>Punti Accumulati</h3>
    <p id="punti">0</p>

    <input type="text" id="codice" placeholder="Inserisci codice segreto">
    <button onclick="aggiungiPunto()">Aggiungi Punto</button>

    <h3>Tempo Rimanente</h3>
    <p id="conto-alla-rovescia">N/A</p>

    <h3>Storico Punti</h3>
    <table>
        <thead>
            <tr>
                <th>Punti</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody id="storico-punti"></tbody>
    </table>

    <br>
    <button class="btn-admin" onclick="window.location.href='admin.html'">Area Admin</button>
    <button onclick="tornaMenu()">Esci</button>
</div>

<script>
    const codiceSegreto = "060471";
    const codiceReset = "finepromo";

    function generaID() {
        return Math.random().toString(36).substring(2, 7);
    }

    function tornaMenu() {
        document.querySelectorAll(".container").forEach(c => c.style.display = "none");
        document.getElementById("menu-iniziale").style.display = "block";
    }

    function mostraRegistrazione() {
        document.getElementById("menu-iniziale").style.display = "none";
        document.getElementById("registrazione").style.display = "block";
    }

    function mostraAccesso() {
        document.getElementById("menu-iniziale").style.display = "none";
        document.getElementById("accesso").style.display = "block";
    }

    function salvaNuovaTessera() {
        let nome = document.getElementById("nome").value.trim();
        let cognome = document.getElementById("cognome").value.trim();

        if (nome === "" && cognome === "") {
            alert("Inserisci almeno Nome o Cognome");
            return;
        }

        const id = generaID();

        const cliente = {
            nome: nome,
            cognome: cognome,
            id: id,
            punti: 0,
            storico: [],
            dataInizio: null
        };

        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");
        lista.push(cliente);
        localStorage.setItem("clienti", JSON.stringify(lista));

        mostraTessera(cliente);
    }

    function accediTessera() {
        let id = document.getElementById("codice-tessera").value.trim();
        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");

        let cliente = lista.find(c => c.id === id);

        if (!cliente) {
            alert("ID non trovato");
            return;
        }

        mostraTessera(cliente);
    }

    function mostraTessera(cliente) {
        document.querySelectorAll(".container").forEach(c => c.style.display = "none");
        document.getElementById("tessera").style.display = "block";

        document.getElementById("nome-salvato").textContent = cliente.nome;
        document.getElementById("cognome-salvato").textContent = cliente.cognome;

        document.getElementById("id-tessera-top").textContent = cliente.id;

        document.getElementById("punti").textContent = cliente.punti;

        caricaStorico(cliente);
        aggiornaConto(cliente);
    }

    function aggiungiPunto() {
        let codice = document.getElementById("codice").value.trim();
        let id = document.getElementById("id-tessera-top").textContent;

        let lista = JSON.parse(localStorage.getItem("clienti") || "[]");
        let cliente = lista.find(c => c.id === id);

        if (!cliente) return;

        if (codice === codiceSegreto) {
            cliente.punti++;
            cliente.storico.push({ punti: 1, data: new Date().toLocaleString() });

            if (!cliente.dataInizio) cliente.dataInizio = Date.now();

            localStorage.setItem("clienti", JSON.stringify(lista));

            mostraTessera(cliente);

        } else if (codice === codiceReset) {
            cliente.punti = 0;
            cliente.storico = [];
            cliente.dataInizio = null;

            localStorage.setItem("clienti", JSON.stringify(lista));

            mostraTessera(cliente);

        } else {
            alert("Codice errato");
        }

        document.getElementById("codice").value = "";
    }

    function caricaStorico(cliente) {
        let tabella = document.getElementById("storico-punti");
        tabella.innerHTML = "";

        cliente.storico.forEach(entry => {
            let riga = document.createElement("tr");
            riga.innerHTML = `<td>${entry.punti}</td><td>${entry.data}</td>`;
            tabella.appendChild(riga);
        });
    }

    function aggiornaConto(cliente) {
        if (!cliente.dataInizio) {
            document.getElementById("conto-alla-rovescia").textContent = "N/A";
            return;
        }

        let scadenza = cliente.dataInizio + (365 * 24 * 60 * 60 * 1000);
        let diff = scadenza - Date.now();

        if (diff <= 0) {
            document.getElementById("conto-alla-rovescia").textContent = "Tempo scaduto";
            return;
        }

        let giorni = Math.floor(diff / 86400000);
        document.getElementById("conto-alla-rovescia").textContent = giorni + " giorni rimanenti";
    }
</script>

</body>
</html>
